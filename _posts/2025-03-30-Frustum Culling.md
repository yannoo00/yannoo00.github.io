---
title:  "Frustum Culling (절두체 컬링)"
layout: post
excerpt: "카메라 시야 영역에 포함된 물체만 선별해서 rendering 하는 기법"

categories:
  - Graphics
tags:
  - [DirectX, graphics]

toc: true
toc_sticky: true
 
date: 2025-03-30
last_modified_at: 2025-03-30
---

<br>


# Frustum Culling 
 
![Image](https://github.com/user-attachments/assets/c39c62ea-5990-4541-89b1-4faaedecd71c)
<br>


절두체 컬링은 <b>camera 시야에 보이는 물체만</b> 판단해서 렌더링 하는 기법이다.  
절두체 평면은 사진과 같이 상하좌우, 근평면과 원평면 6개의 평면으로 구성되어 있고,  
이 6개의 면의 평면 방정식과 렌더링할 물체들을 감싸는 구, 혹은 직육면체의 경계 테스팅을 통해  
렌더링할지 말지를 판단하게 된다.  

<br>

## 평면의 방정식  

6개 평면을 기준으로 적절한 위치에 점이 존재하는지 여부를 계산하기에 앞서,  
일단은 평면의 방정식을 이해해야 한다.  
2차원 공간에서 직선을 방정식으로  y = ax+b 꼴로 쉽게 표현했듯이 평면도 방정식으로 표현할 수 있다.  
우선 하나의 평면은 법선벡터와 평면 위의 한 점으로 정의한다(이 두가지로 유일한 평면을 정의할 수 있다).  
각각 법선벡터 n(a,b,c)와 점 P(x0, y0, z0)라고 하자.  
이 상황에서 임의의 점 P(x,y,z)가 같은 평면 위에 있을 조건을 생각해보자.  


이 때 평면의 방향을 나타내는 법선 벡터와 평면위의 두 점을 지나는 벡터는 서로 직교하기 때문에 내적은 0이다.  
식을 타이핑하기가 어려운데  
![Image](https://github.com/user-attachments/assets/bc5c0af2-5ad4-4c19-ad81-afaa5accb23f)  
h가 법선벡터고 a에서 p로 향하는 벡터와 h를 내적하는 공식이다.  
이 때 d는 평면을 정의하면서 주어지는 값인 상수가 되기에 따로 d로 빼돌린다.  
그럼 이제 ax + by + cz + d = 0 이라는 평면의 방정식이 성립한다. 이 때 d의 의미는 뭘까?  

<b>d = -(ax0 + by0 + cz0)</b> 이다. (ax0 + by0 + cz0) 이는 곧 앞서 설정한 법선벡터 n과 점 P의 내적 계산식이다.  즉 d는 n과 P의 내적에 음의 부호를 설정한 결과로 볼 수 있다.  

따라서 d의 부호는 원점이 평면의 바깥쪽에 있는지(+), 평면의 안쪽에 있는지(-)를 알려준다.  

<br>

## 평면과 객체의 부호가 있는 거리 구하기

모든 객체(skybox 처럼 반드시 렌더링해야하는 객체는 제외하고)에 대해서  
6개의 절두체 평면에 대해 거리 판정을 하고 한 평면에라도 벗어난다면 렌더링 대상에서 제외한다.  

그렇다면 어떻게 임의의 점이 한 평면에 대해 렌더링을 위한 유효한 거리(=평면 안쪽)에 있다는 것을 판별할까?  
물체의 중심점에서 평면까지의 <b>부호가 있는 거리</b>를 통해, 부호에 따라 평면의 앞/뒤에 있음을 판별할 수 있다.  


![Image](https://github.com/user-attachments/assets/5f432434-d17e-437f-b36b-06b860071ece)

이 그림에서 점 P가 평면 안쪽에 있는지 판별해보자.  
이 때 평면의 d값은 원점이 평면의 안쪽에 있으므로 음수이다.  
P를 법선벡터에 투영해서 op값을 구했을 때 이 벡터가 그림의 OP'처럼 법선벡터와 같은 방향이면 양수일 것이고 원점 너머에 P가 위치했다면 op는 음수일 것이다.  

원점과 평면의 거리를 고려해서 d와 op 값을 더하면 점이 어디있는지 알 수 있다.  
그림 상황에서 d는 음수이고 op(내적 결과 스칼라)는 양수다. 둘을 더했을 때 원점이 P보다 평면에서 멀리 있으므로 값은 여전히 음수일 것이다.  

음수이면 점은 평면 안쪽에 있는 것이다. 그 외의 상황을 대입해서 생각해보면 결과가 양수일 때 (P가 평면 너머에 있는 경우) 점이 평면 바깥에 있다는 것을 알 수 있다.  



따라서 점P에서 평면ABC까지 거리를 구하는 공식은 distance = |A * Px + B * Py + C * Pz + D| 가 된다.  






<br>
<br>
<br>

참고:  _이득우의 게임수학_, _3D 게임 프로그래밍 입문_, 인프런 Rookiss