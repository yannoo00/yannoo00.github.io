---
title:  "CLOVA Stock Agent"
layout: post
excerpt: "CLOVA Stock Agent"

categories:
  - LLM
tags:
  - [AI, CLOVA]

toc: true
toc_sticky: true
 
date: 2025-07-25
last_modified_at: 2025-07-25
---

<br>

## CLOVA AI Agent

네이버 클로바 AI를 이용하여 금융 도메인 AI Agent를 만들어보자.  
이 agent는 "삼성전자 어제 종가 알려줘" 라는 쿼리에 금융 데이터를 활용하여 올바른 데이터를 제공한다.  
 
주식 데이터는 yfinance 라이브러리를 활용해서 얻어왔다.  
이 때 주식 정보를 기업명이 아닌 기업명마다 할당되어 있는 Ticker 값으로 가져와야 한다.    
  "삼성전자": "005930.KS",   "삼성카드": "029780.KS",  이런 식이다.  

문제는 사용자의 질문에는 부정확한 기업명도 들어올 수 있다는 것이다. 예를 들어 "삼전", "엘지 엔솔" 등 보편적으로 쓰이는 약어도 많다.  
정확한 주식 데이터를 가져오기 위해선 사용자가 의도한 정확한 기업명으로 Ticker 값을 찾아야 한다.  

<img width="1699" height="902" alt="Image" src="https://github.com/user-attachments/assets/23d6700b-a460-49d1-9505-18ae569ea7c2" /> 
이를 해결하기 위해서 CLOVA의 [Function Calling](https://api.ncloud-docs.com/docs/clovastudio-chatcompletionsv3-fc)과 텍스트 임베딩을 활용했다.  

대략적인 Flow Chart는 다음과 같다.  
<center><img width="497" height="928" alt="Image" src="https://github.com/user-attachments/assets/c7fa1fd3-56b2-43be-a09c-2d1084faaaae" /></center>


Function Calling은 CLOVA가 사용할 수 있는 일종의 함수 시그니쳐 목록을 작성하여 대화에 활용할 수 있도록 하는 기능이다.  
예를 들어  
```python
               "type": "function",
               "function": {
                   "name": "convert_query_to_ticker",
                   "description": "사용자 쿼리에서 기업명을 찾아 정확한 ticker 코드로 치환한 새로운 쿼리를 반환합니다. 질문에 기업명이 포함된 경우 반드시 호출해야 합니다.",
                   "parameters": {
                       "type": "object",
                       "properties": {
                           "user_query": {
                               "type": "string",
                               "description": "사용자의 원본 질문 전체"
                           },
                           "extracted_company_name": {
                               "type": "string",
                               "description": "사용자 쿼리에서 추출한 기업명 또는 기업 관련 키워드 (예: '삼전', '엘지에너솔', '현차', '카카오' 등). 사용자가 실제로 언급한 표현 그대로 추출해주세요."
                           }
                       },
                       "required": ["user_query", "extracted_company_name"]
                   }
               }
           },

           {
               "type": "function",
               "function": {
                   "name": "nothing_to_convert",
                   "description": "사용자 쿼리에 기업명이 포함되지 않은 경우 호출합니다.",
                   "parameters": {
                       "type": "object",
                       "properties": {
                           "user_query": {
                               "type": "string",
                               "description": "사용자의 원본 질문 전체"
                           }
                       },
                      "required": ["user_query"]
                    }
               }
           },
```

이렇게 작성해두면 description을 보고 CLOVA가 어떤 상황에 어떤 함수를 선택하여 
어떤 arugments를 넣을지까지 판단하여 함수를 call하고 그 결과만을 return 해주게 된다.  

나는 yfinance에 있는 국내 KOSPI 상장주의 정식 기업명 ex) 삼성전자, LG에너지솔루션, 현대차 들을 vector 임베딩 해두고 사용자의 질문에 기업명이 들어왔을 경우 해당 기업명만을 추출하여 인자로 전달하는 함수를 작성했다.  

이 함수에 '삼전'이 들어오면, CLOVA는 1차적으로 사용자 질의에 기업명이 포함되어있으니  convert_query_to_ticker()를 호출하게 된다.  
이 함수에서는 '삼전'을 받아 임베딩 리스트의 기업들과 cos 유사도 비교(1024차원)를 통해 가장 유사한 기업명 상위 10개를 return한다.  

 그 결과를 다시 원본 질의와 함께 CLOVA에게 전달하면 CLOVA는 최종적으로 사용자가 의도한 정식 기업명을 하나 return하고 그것을 기업명-Ticker 맵에 넣어 Ticker를 최종적으로 반환한다.  

 이후 해당 Ticker를 가지고 골든크로스, 3일 연속 10%이상 상승주 등을 찾는 연산을 수행하게 된다.  
